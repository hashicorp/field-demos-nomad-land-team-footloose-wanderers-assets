////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//  Repo:           terraform/config
//  File Name:      main.tf
//  Author:         Patrick Gryzan
//  Company:        Hashicorp
//  Date:           May 2021
//  Description:    This is the main execution file environment configuration
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Environment
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
provider "nomad" {
    address     = var.nomad.address
    region      = var.nomad.region
}

locals {
    base_path   = "../../nomad/jobs"
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Step 1 - Deploy the Products Database
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
resource "nomad_job" "product_db" {
    jobspec     = file("${local.base_path}/product-db.hcl")

    provisioner "local-exec" {
        command = "sleep 10"
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Step 2 - Deploy the Legacy Application
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
resource "nomad_job" "legacy_app" {
    jobspec     = file("${local.base_path}/legacy-app.hcl")

    provisioner "local-exec" {
        command = "sleep 10"
    }

    depends_on  = [ nomad_job.product_db ]
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Step 3 - Deploy the Product API
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
resource "nomad_job" "product_api" {
    jobspec     = file("${local.base_path}/product-api.hcl")

    provisioner "local-exec" {
        command = "sleep 10"
    }

    depends_on  = [ nomad_job.product_db ]
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Step 4 - Deploy the Payment API
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
resource "nomad_job" "payment_api" {
    jobspec     = file("${local.base_path}/payment-api.hcl")

    provisioner "local-exec" {
        command = "sleep 10"
    }

    depends_on  = [ nomad_job.legacy_app, nomad_job.product_api ]
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Step 4 - Deploy the Public API
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
resource "nomad_job" "public_api" {
    jobspec     = file("${local.base_path}/public-api.hcl")

    provisioner "local-exec" {
        command = "sleep 10"
    }

    depends_on  = [ nomad_job.payment_api ]
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Step 4 - Deploy the Frontend
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
resource "nomad_job" "frontend" {
    jobspec     = file("${local.base_path}/frontend.hcl")
    depends_on  = [ nomad_job.public_api ]
}